<?php
/**
 * @version		$Id: 2_0_5.php 575 2009-03-10 11:44:00Z CY $
 * @package		Mosets Tree
 * @copyright	(C) 2005-2009 Mosets Consulting. All rights reserved.
 * @license		GNU General Public License
 * @author		Lee Cher Yeong <mtree@mosets.com>
 * @url			http://www.mosets.com/tree/
 */

defined('_JEXEC') or die('Restricted access');

class mUpgrade_2_0_5 extends mUpgrade {
	function upgrade() {
		global $database;

		// Update coredesc class code
		$database->setQuery('UPDATE #__mt_fieldtypes SET ft_class = "class mFieldType_coredesc extends mFieldType {\r\n	var $name = \'link_desc\';\r\n	function parseValue($value) {\r\n		$params[\'stripAllTagsBeforeSave\'] = $this->getParam(\'stripAllTagsBeforeSave\',0);\r\n		$params[\'allowedTags\'] = $this->getParam(\'allowedTags\',\'u,b,i,a,ul,li,pre,br,blockquote\');\r\n		if($params[\'stripAllTagsBeforeSave\']) {\r\n			$value = $this->stripTags($value,$params[\'allowedTags\']);\r\n		}\r\n		return $value;		\r\n	}\r\n	function getInputHTML() {\r\n		global $mtconf;\r\n		\r\n		$inBackEnd = (substr(dirname($_SERVER[\'PHP_SELF\']),-13) == \'administrator\') ? true : false;\r\n		if( ($inBackEnd AND $mtconf->get(\'use_wysiwyg_editor_in_admin\')) || (!$inBackEnd AND $mtconf->get(\'use_wysiwyg_editor\')) ) {\r\n			ob_start();\r\n			editorArea( \'editor1\',  $this->getValue() , $this->getInputFieldName(1), \'100%\', $this->getSize(), \'75\', \'25\' );\r\n			$html = ob_get_contents();\r\n			ob_end_clean();\r\n		} else {\r\n			$html = \'<textarea class=\"inputbox\" name=\"\' . $this->getInputFieldName(1) . \'\" style=\"width:95%;height:\' . $this->getSize() . \'px\">\' . htmlspecialchars($this->getValue()) . \'</textarea>\';\r\n		}\r\n		return $html;\r\n	}\r\n	function getSearchHTML() {\r\n		return \'<input class=\"inputbox\" type=\"text\" name=\"\' . $this->getName() . \'\" size=\"30\" />\';\r\n	}\r\n	function getOutput($view=1) {\r\n		$params[\'parseUrl\'] = $this->getParam(\'parseUrl\',1);\r\n		$params[\'summaryChars\'] = $this->getParam(\'summaryChars\',255);\r\n		$params[\'stripSummaryTags\'] = $this->getParam(\'stripSummaryTags\',1);\r\n		$params[\'stripDetailsTags\'] = $this->getParam(\'stripDetailsTags\',1);\r\n		$params[\'parseMambots\'] = $this->getParam(\'parseMambots\',0);\r\n		$params[\'allowedTags\'] = $this->getParam(\'allowedTags\',\'u,b,i,a,ul,li,pre,br,blockquote\');\r\n		$params[\'showReadMore\'] = $this->getParam(\'showReadMore\',0);\r\n		$params[\'whenReadMore\'] = $this->getParam(\'whenReadMore\',0);\r\n		$params[\'txtReadMore\'] = $this->getParam(\'txtReadMore\',(( $GLOBALS[\'_VERSION\']->RELEASE == \'1.0\' )?_READ_MORE:JTEXT::_( \'Read More...\' )));\r\n		\r\n		$html = $this->getValue();\r\n		\r\n		// Details view\r\n		if($view == 1) {\r\n			global $mtconf;\r\n			if($params[\'stripDetailsTags\']) {\r\n				$html = $this->stripTags($html,$params[\'allowedTags\']);\r\n			}\r\n			if($params[\'parseUrl\'] AND $view == 0) {\r\n				$regex = \'/http:\\/\\/(.*?)(\\s|$)/i\';\r\n				$html = preg_replace_callback( $regex, array($this,\'linkcreator\'), $html );\r\n			}\r\n			if (!$mtconf->get(\'use_wysiwyg_editor\') && $params[\'stripDetailsTags\'] && !in_array(\'br\',explode(\',\',$params[\'allowedTags\'])) && !in_array(\'p\',explode(\',\',$params[\'allowedTags\'])) ) {\r\n				$html = nl2br(trim($html));\r\n			}\r\n			if($params[\'parseMambots\']) {\r\n				$this->parseMambots($html);\r\n			}\r\n		// Summary view\r\n		} else {\r\n			global $Itemid;\r\n			$html = preg_replace(\'@{[\\/\\!]*?[^<>]*?}@si\', \'\', $html);\r\n			if($params[\'stripSummaryTags\']) {\r\n				$html = strip_tags( $html );\r\n			}\r\n			$trimmed_desc = trim($this->html_substr($html,0,$params[\'summaryChars\']));\r\n			if ($this->strlen_utf8($html) > $params[\'summaryChars\']) {\r\n				$html = $trimmed_desc;\r\n				$html .= \' <b>...</b>\';\r\n			}\r\n			if( $params[\'showReadMore\'] && ($params[\'whenReadMore\'] == 1 || ($params[\'whenReadMore\'] == 0 && $this->strlen_utf8($html) > $params[\'summaryChars\'])) ) {\r\n				if(!empty($trimmed_desc)) {\r\n					$html .= \'<br />\';\r\n				}\r\n				$html .= \' <a href=\"\' . JRoute::_(\'index.php?option=com_mtree&task=viewlink&link_id=\' . $this->getLinkId() . \'&Itemid=\' . $Itemid) . \'\" class=\"readon\">\' . $params[\'txtReadMore\'] . \'</a>\';\r\n			}\r\n		}\r\n		return $html;\r\n	}\r\n}"  WHERE field_type = "coredesc" LIMIT 1');
		$database->query();

		// Update coredesc version number
		$database->setQuery('UPDATE #__mt_fieldtypes_info SET ft_version = "2" WHERE ft_id = "21" LIMIT 1');
		$database->query();
		$this->printStatus( 'Updated coredesc field type to version 2.' );

		// Update corerating class code
		$database->setQuery('UPDATE #__mt_fieldtypes SET ft_class = "class mFieldType_corerating extends mFieldType {\r\n	var $name = \'link_rating\';\r\n	var $numOfSearchFields = 0;\r\n	var $numOfInputFields = 0;\r\n	function getOutput($view=1) {\r\n		return round($this->getValue(),2);\r\n	}\r\n}"  WHERE field_type = "corerating" LIMIT 1');
		$database->query();

		// Update corerating version number
		$database->setQuery('UPDATE #__mt_fieldtypes_info SET ft_version = "2" WHERE ft_id = "1" LIMIT 1');
		$database->query();
		$this->printStatus( 'Updated corerating field type to version 2.' );

		// Update image class code
		$database->setQuery('UPDATE #__mt_fieldtypes SET ft_class = "class mFieldType_image extends mFieldType_file {\r\n	function parseValue($value) {\r\n		global $mtconf;\r\n		$params[\'size\'] = intval(trim($this->getParam(\'size\')));\r\n		if($params[\'size\'] <= 0) {\r\n			$size = $mtconf->get(\'resize_listing_size\');\r\n		} else {\r\n			$size = intval($params[\'size\']);\r\n		}\r\n		$mtImage = new mtImage();\r\n		$mtImage->setMethod( $mtconf->get(\'resize_method\') );\r\n		$mtImage->setQuality( $mtconf->get(\'resize_quality\') );\r\n		$mtImage->setSize( $size );\r\n		$mtImage->setTmpFile( $value[\'tmp_name\'] );\r\n		$mtImage->setType( $value[\'type\'] );\r\n		$mtImage->setName( $value[\'name\'] );\r\n		$mtImage->setSquare(false);\r\n		$mtImage->resize();\r\n		$value[\'data\'] = $mtImage->getImageData();\r\n		$value[\'size\'] = strlen($value[\'data\']);\r\n		\r\n		return $value;\r\n	}\r\n	function getJSValidation() {\r\n		$js = \'\';\r\n		$js .= \'} else if (!hasExt(form.\' .$this->getInputFieldName(1) . \'.value,\\\\\'gif|png|jpg|jpeg\\\\\')) {\'; \r\n		$js .= \'alert(\"\' . $this->getCaption() . \': Please select an image with one of these extensions - gif,png,jpg,jpeg.\");\';\r\n		return $js;\r\n	}\r\n	function getOutput() {\r\n		$html = \'\';\r\n		$html .= \'<img src=\"\' . $this->getDataAttachmentURL() . \'\" />\';\r\n		return $html;\r\n	}\r\n	function getInputHTML() {\r\n		$html = \'\';\r\n		if( $this->attachment > 0 ) {\r\n			$html .= $this->getKeepFileCheckboxHTML($this->attachment);\r\n			$html .= \'<label for=\"\' . $this->getKeepFileName() . \'\"><img src=\"\' . $this->getDataAttachmentURL() . \'\" hspace=\"5\" vspace=\"0\" /></label>\';\r\n			$html .= \'</br >\';\r\n		}\r\n		$html .= \'<input class=\"inputbox\" type=\"file\" name=\"\' . $this->getInputFieldName(1) . \'\" />\';\r\n		return $html;\r\n	}\r\n	\r\n}"  WHERE field_type = "image" LIMIT 1');
		$database->query();

		// Update image version number
		$database->setQuery('UPDATE #__mt_fieldtypes_info SET ft_version = "2" WHERE ft_id = "25" LIMIT 1');
		$database->query();
		$this->printStatus( 'Updated image field type to version 2.' );

		// Update videoplayer class code
		$database->setQuery('UPDATE #__mt_fieldtypes SET ft_class = "class mFieldType_videoplayer extends mFieldType_file {\r\n\r\n	function getOutput() {\r\n		$html =\'\';\r\n		$filename = $this->getValue();\r\n		$format = $this->getParam(\'format\');\r\n		$id = $format.$filename;\r\n		$width = $this->getParam(\'width\');\r\n		$height = $this->getParam(\'height\');\r\n		$autoplay = $this->getParam(\'autoplay\',false);\r\n		\r\n		switch($format) {\r\n			case \'mov\':\r\n				$html .= \'<object classid=\"clsid:02BF25D5-8C17-4B23-BC80-D3488ABDDC6B\" width=\"\' . $width . \'\" height=\"\' . $height. \'\" codebase=\"http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0\" align=\"middle\">\';\r\n				$html .= \'<param name=\"src\" value=\"\' . $this->getDataAttachmentURL() . \'\" />\';\r\n				$html .= \'<param name=\"autoplay\" value=\"\' . $autoplay . \'\" />\';\r\n				$html .= \'<embed src=\"\' . $this->getDataAttachmentURL() . \'\" type=\"video/quicktime\" width=\"\' . $width . \'\" height=\"\' . $height . \'\" pluginspage=\"http://www.apple.com/quicktime/download/\" align=\"middle\" autoplay=\"\' . $autoplay . \'\" />\';\r\n				$html .= \'</object>\';\r\n				break;\r\n			case \'divx\':\r\n				$html .= \'\';\r\n				$html .= \'<object classid=\"clsid:67DABFBF-D0AB-41fa-9C46-CC0F21721616\" width=\"\' . $width . \'\" height=\"\' . $height . \'\" codebase=\"http://go.divx.com/plugin/DivXBrowserPlugin.cab\">\';\r\n				$html .= \'<param name=\"src\" value=\"\' . $this->getDataAttachmentURL() . \'\" />\';\r\n				$html .= \'<param name=\"autoPlay\" value=\"\' . $autoplay . \'\" />\';\r\n				$html .= \'<embed src=\"\' . $this->getDataAttachmentURL() . \'\" type=\"video/divx\" width=\"\' . $width . \'\" height=\"\' . $height . \'\" autoPlay=\"\' . $autoplay . \'\" pluginspage=\"http://go.divx.com/plugin/download/\" />\';\r\n				$html .= \'</object>\';\r\n				break;\r\n			case \'windowsmedia\':\r\n				$html .= \'<object classid=\"CLSID:6BF52A52-394A-11D3-B153-00C04F79FAA6\" id=\"\' . $id . \'\" width=\"\' . $width . \'\" height=\"\' . $height . \'\" type=\"application/x-oleobject\">\';\r\n				$html .= \'<param name=\"URL\" value=\"\' . $this->getDataAttachmentURL() . \'\" />\';\r\n				$html .= \'<param name=\"wmode\" value=\"opaque\" />\';\r\n				$html .= \'<param name=\"ShowControls\" value=\"1\" />\';\r\n				$html .= \'<param name=\"autoStart\" value=\"\' . (($autoplay)?\'1\':\'0\') . \'\" />\';\r\n				$html .= \'<embed src=\"\' . $this->getDataAttachmentURL() . \'\" type=\"application/x-mplayer2\" width=\"\' . $width . \'\" height=\"\' . $height . \'\" wmode=\"opaque\" border=\"0\" autoStart=\"\' . (($autoplay)?\'1\':\'0\') . \'\" />\';\r\n				$html .= \'</object>\';\r\n				break;\r\n		}\r\n		return $html;\r\n	}\r\n}"  WHERE field_type = "videoplayer" LIMIT 1');
		$database->query();

		// Update videoplayer version number
		$database->setQuery('UPDATE #__mt_fieldtypes_info SET ft_version = "2" WHERE ft_id = "45" LIMIT 1');
		$database->query();
		$this->printStatus( 'Updated videoplayer field type to version 2.' );

		// Update videoplayer params.xml
		$database->setQuery("UPDATE #__mt_fieldtypes_att SET filedata = 0x3C6D6F73706172616D7320747970653D226D6F64756C65223E0A093C706172616D733E0A09093C706172616D206E616D653D22666F726D61742220747970653D226C697374222064656661756C743D2222206C6162656C3D22566964656F20466F726D6174223E0A0909093C6F7074696F6E2076616C75653D226D6F76223E517569636B74696D65204D6F7669653C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2264697678223E446976583C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2277696E646F77736D65646961223E57696E646F7773204D6564696120566964656F3C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D2277696474682220747970653D2274657874222064656661756C743D2222206C6162656C3D22576964746822202F3E0A09093C706172616D206E616D653D226865696768742220747970653D2274657874222064656661756C743D2222206C6162656C3D2268656967687422202F3E0A09093C706172616D206E616D653D226175746F706C61792220747970653D22726164696F222064656661756C743D2266616C736522206C6162656C3D224175746F20506C6179223E0A0909093C6F7074696F6E2076616C75653D2274727565223E5965733C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2266616C7365223E4E6F3C2F6F7074696F6E3E0A09093C2F706172616D3E0A09090A093C2F706172616D733E0A3C2F6D6F73706172616D733E, filesize = 572 WHERE ft_id = 45 AND filename = 'params.xml' LIMIT 1");
		$database->query();

		// Update coredesc params.xml
		$database->setQuery("UPDATE #__mt_fieldtypes_att SET filedata = 0x3C6D6F73706172616D7320747970653D226D6F64756C65223E0A093C706172616D733E0A09093C706172616D206E616D653D2273756D6D61727943686172732220747970653D2274657874222064656661756C743D2232353522206C6162656C3D224E756D626572206F662053756D6D617279206368617261637465727322202F3E0A09093C706172616D206E616D653D22737472697053756D6D617279546167732220747970653D22726164696F222064656661756C743D223122206C6162656C3D22537472697020616C6C2048544D4C207461677320696E2053756D6D617279207669657722206465736372697074696F6E3D2253657474696E67207468697320746F207965732077696C6C2072656D6F766520616C6C2074616773207468617420636F756C6420706F74656E7469616C6C7920616666656374207768656E2076696577696E672061206C697374206F66206C697374696E67732E223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D22737472697044657461696C73546167732220747970653D22726164696F222064656661756C743D223122206C6162656C3D22537472697020616C6C2048544D4C207461677320696E2044657461696C73207669657722206465736372697074696F6E3D2253657474696E67207468697320746F207965732077696C6C2072656D6F766520616C6C2074616773206578636570742074686F73652074686174206172652073706563696669656420696E2027416C6C6F7765642074616773272E223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D22706172736555726C2220747970653D22726164696F222064656661756C743D223122206C6162656C3D2250617273652055524C206173206C696E6B20696E2044657461696C732076696577223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A09093C2F706172616D3E0A0A09093C706172616D206E616D653D227374726970416C6C546167734265666F7265536176652220747970653D22726164696F222064656661756C743D223022206C6162656C3D22537472697020616C6C2048544D4C2074616773206265666F72652073746F72696E6720746F20646174616261736522206465736372697074696F6E3D224966205759535957494720656469746F7220697320656E61626C656420696E207468652066726F6E742D656E642C2074686973206665617475726520616C6C6F7720796F7520746F20737472697020616E7920706F74656E7469616C6C79206861726D66756C20636F6465732E20596F752063616E207374696C6C20616C6C6F7720736F6D6520746167732077697468696E206465736372697074696F6E206669656C642C2077686963682063616E206265207370656369666965642062656C6F772E223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D22616C6C6F776564546167732220747970653D2274657874222064656661756C743D22752C622C692C612C756C2C6C692C7072652C626C6F636B71756F746522206C6162656C3D22416C6C6F776564207461677322206465736372697074696F6E3D22456E7465722074686520746167206E616D65732073657065726174656420627920636F6D6D612E205468697320706172616D6574657220616C6C6F7720796F7520746F2061636365707420736F6D652048544D4C2074616773206576656E20696620796F75206861766520656E61626C65207374726970696E67206F6620616C6C2048544D4C20746167732061626F76652E22202F3E0A09093C706172616D206E616D653D2270617273654D616D626F74732220747970653D22726164696F222064656661756C743D223022206C6162656C3D225061727365204D616D626F747322206465736372697074696F6E3D22456E61626C696E6720746869732077696C6C207061727365206D616D626F747320636F646573732077697468696E20746865206465736372697074696F6E206669656C64223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D2273686F77526561644D6F72652220747970653D22726164696F222064656661756C743D223022206C6162656C3D2253686F77202671756F743B52656164204D6F72652E2E2E2671756F743B22206465736372697074696F6E3D2253686F77202671756F743B52656164204D6F72652E2E2671756F743B2069662061206465736372697074696F6E207465787420636C697070656420696E2053756D6D61727920566965772E223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D227768656E526561644D6F72652220747970653D226C697374222064656661756C743D223022206C6162656C3D225768656E20746F2073686F77202671756F743B52656164204D6F72652E2E2671756F743B22206465736372697074696F6E3D225468697320616C6C6F7720796F7520746F20736574207768656E20746F2073686F7720746865202671756F743B52656164204D6F72652E2E2671756F743B206C696E6B2E223E0A0909093C6F7074696F6E2076616C75653D2230223E4F6E6C79207768656E206465736372697074696F6E20697320636C697070656420696E2053756D6D61727920566965773C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E416C6C207468652074696D653C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D22747874526561644D6F72652220747970653D2274657874222064656661756C743D2252656164204D6F72652E2E2E22206C6162656C3D2252656164204D6F7265207465787422206465736372697074696F6E3D22456E74657220746865202671756F743B52656164204D6F72652E2E2671756F743B20746578742E22202F3E0A093C2F706172616D733E0A3C2F6D6F73706172616D733E, filesize = 2541 WHERE ft_id = 21 AND filename = 'params.xml' LIMIT 1");
		$database->query();

		updateVersion(2,0,5);
		$this->updated = true;
		return true;
	}
}
?>
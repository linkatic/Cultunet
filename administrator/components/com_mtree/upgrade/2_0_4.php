<?php
/**
 * @version		$Id: 2_0_4.php 575 2009-03-10 11:44:00Z CY $
 * @package		Mosets Tree
 * @copyright	(C) 2005-2009 Mosets Consulting. All rights reserved.
 * @license		GNU General Public License
 * @author		Lee Cher Yeong <mtree@mosets.com>
 * @url			http://www.mosets.com/tree/
 */

defined('_JEXEC') or die('Restricted access');

class mUpgrade_2_0_4 extends mUpgrade {
	function upgrade() {
		global $database;

		$database->setQuery( 'DELETE FROM #__mt_customfields WHERE field_type IN (\'coremetakey\',\'coremetadesc\') AND cf_id NOT IN (26,27) LIMIT 2' );
		$database->query();
		$this->printStatus( 'Cleaned up of CORE META Keys and CORE META Desc fields.' );
		
		$database->setQuery( 'DELETE FROM #__mt_config WHERE varname = \'fullmenu_tree_level\' LIMIT 1' );
		$database->query();
		$this->printStatus( 'Removed fullmenu_tree_level config.' );

		changeColumnType('links', 'link_rating', 'DECIMAL( 7, 6 )', 'UNSIGNED NOT NULL DEFAULT \'0.00\'');

		// Update date params.xml
		$database->setQuery("UPDATE #__mt_fieldtypes_att SET filedata = 0x3c6d6f73706172616d7320747970653d226d6f64756c65223e0d0a093c706172616d733e0d0a09093c706172616d206e616d653d227374617274596561722220747970653d2274657874222064656661756c743d2222206c6162656c3d225374617274207965617222206465736372697074696f6e3d22456e74657220746865207374617274696e672079656172206f72206561726c69657374207965617220617661696c61626c6520666f722073656c656374696f6e2e204966206c65667420656d7074792c2069742077696c6c2064656661756c7420746f2037302079656172732061676f2066726f6d207468652063757272656e7420796561722e22202f3e0d0a09093c706172616d206e616d653d22656e64596561722220747970653d2274657874222064656661756c743d2222206c6162656c3d22456e64207965617222206465736372697074696f6e3d22456e74657220746865206c61746573742079656172206f7220617661696c61626c6520666f722073656c656374696f6e2e204966206c65667420656d7074792c207468652063757272656e7420796561722077696c6c20626520757365642e22202f3e0d0a09093c706172616d206e616d653d2264617465466f726d61742220747970653d226c697374222064656661756c743d2222206c6162656c3d224461746520466f726d617422203e0d0a0909093c6f7074696f6e2076616c75653d22592d6d2d64223e323030372d30362d30313c2f6f7074696f6e3e0d0a0909093c6f7074696f6e2076616c75653d226a2e6e2e59223e312e362e323030373c2f6f7074696f6e3e0d0a0909093c6f7074696f6e2076616c75653d226420462059223e3031204a756e6520323030373c2f6f7074696f6e3e0d0a0909093c6f7074696f6e2076616c75653d226a53205c6f5c6620462059223e317374206f66204a756e6520323030373c2f6f7074696f6e3e0d0a0909093c6f7074696f6e2076616c75653d226a2f6e2f59223e312f362f323030373c2f6f7074696f6e3e0d0a0909093c6f7074696f6e2076616c75653d226e2f6a2f59223e362f312f323030373c2f6f7074696f6e3e0d0a09093c2f706172616d3e09090d0a093c2f706172616d733e0d0a3c2f6d6f73706172616d733e, filesize = 833 WHERE ft_id = 47 AND filename = 'params.xml' LIMIT 1");
		$database->query();

		// Update audioplayer params.xml
		$database->setQuery("UPDATE #__mt_fieldtypes_att SET filedata = 0x3c6d6f73706172616d7320747970653d226d6f64756c65223e0a093c706172616d733e0a09093c706172616d206e616d653d226175746f53746172742220747970653d22726164696f222064656661756c743d223022206c6162656c3d224175746f20537461727422206465736372697074696f6e3d224175746f6d61746963616c6c79206f70656e2074686520706c6179657220616e6420737461727420706c6179696e672074686520747261636b2e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22646973706c617966696c656e616d652220747970653d22726164696f222064656661756c743d223122206c6162656c3d22446973706c61792046696c656e616d6522206465736372697074696f6e3d22446973706c61792074686520617564696f27732066696c656e616d652062656c6f772074686520706c617965722e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d226c6f6f702220747970653d22726164696f222064656661756c743d223022206c6162656c3d224c6f6f7022206465736372697074696f6e3d2254686520747261636b2077696c6c206265206c6f6f70656420696e646566696e6974656c79223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d2274657874436f6c6f75722220747970653d2274657874222064656661756c743d2222206c6162656c3d225465787420636f6c6f757222202f3e0a09093c706172616d206e616d653d22736c69646572436f6c6f75722220747970653d2274657874222064656661756c743d2222206c6162656c3d22536c6964657220636f6c6f757222202f3e0a09093c706172616d206e616d653d226c6f61646572436f6c6f75722220747970653d2274657874222064656661756c743d2222206c6162656c3d224c6f6164657220636f6c6f757222202f3e0a09093c706172616d206e616d653d22747261636b436f6c6f75722220747970653d2274657874222064656661756c743d2222206c6162656c3d22547261636b20636f6c6f757222202f3e0a09093c706172616d206e616d653d22626f72646572436f6c6f75722220747970653d2274657874222064656661756c743d2222206c6162656c3d22426f7264657220636f6c6f757222202f3e0a09093c706172616d206e616d653d226261636b67726f756e64436f6c6f75722220747970653d2274657874222064656661756c743d2222206c6162656c3d224261636b67726f756e6420636f6c6f757222202f3e0a09093c706172616d206e616d653d226c6566744261636b67726f756e64436f6c6f75722220747970653d2274657874222064656661756c743d2222206c6162656c3d224c656674206261636b67726f756e6420636f6c6f757222202f3e0a09093c706172616d206e616d653d2272696768744261636b67726f756e64436f6c6f75722220747970653d2274657874222064656661756c743d2222206c6162656c3d225269676874206261636b67726f756e6420636f6c6f757222202f3e0a09093c706172616d206e616d653d2272696768744261636b67726f756e64486f766572436f6c6f75722220747970653d2274657874222064656661756c743d2222206c6162656c3d225269676874206261636b67726f756e6420636f6c6f75722028686f7665722922202f3e0a09093c706172616d206e616d653d226c65667449636f6e436f6c6f75722220747970653d2274657874222064656661756c743d2222206c6162656c3d224c6566742069636f6e20636f6c6f757222202f3e0a09093c706172616d206e616d653d22726967687449636f6e436f6c6f75722220747970653d2274657874222064656661756c743d2222206c6162656c3d2252696768742069636f6e20636f6c6f757222202f3e0a09093c706172616d206e616d653d22726967687449636f6e486f766572436f6c6f75722220747970653d2274657874222064656661756c743d2222206c6162656c3d2252696768742069636f6e20636f6c6f75722028686f7665722922202f3e0a093c2f706172616d733e0a3c2f6d6f73706172616d733e, filesize = 1719 WHERE ft_id = 24 AND filename = 'params.xml' LIMIT 1");
		$database->query();

		// Update audioplayer class code
		$database->setQuery('UPDATE #__mt_fieldtypes SET ft_class = "class mFieldType_audioplayer extends mFieldType_file {\r\n	function getJSValidation() {\r\n\r\n		$js = \'\';\r\n		$js .= \'} else if (!hasExt(form.\' . $this->getName() . \'.value,\\\'mp3\\\')) {\'; \r\n		$js .= \'alert(\"\' . $this->getCaption() . \': Please select a mp3 file.\");\';\r\n		return $js;\r\n	}\r\n	function getOutput() {\r\n		$id = $this->getId();\r\n		$params[\'text\'] = $this->getParam(\'textColour\');\r\n		$params[\'displayfilename\'] = $this->getParam(\'displayfilename\',1);\r\n		$params[\'slider\'] = $this->getParam(\'sliderColour\');\r\n		$params[\'loader\'] = $this->getParam(\'loaderColour\');\r\n		$params[\'track\'] = $this->getParam(\'trackColour\');\r\n		$params[\'border\'] = $this->getParam(\'borderColour\');\r\n		$params[\'bg\'] = $this->getParam(\'backgroundColour\');\r\n		$params[\'leftbg\'] = $this->getParam(\'leftBackgrounColour\');\r\n		$params[\'rightbg\'] = $this->getParam(\'rightBackgrounColour\');\r\n		$params[\'rightbghover\'] = $this->getParam(\'rightBackgroundHoverColour\');\r\n		$params[\'lefticon\'] = $this->getParam(\'leftIconColour\');\r\n		$params[\'righticon\'] = $this->getParam(\'rightIconColour\');\r\n		$params[\'righticonhover\'] = $this->getParam(\'rightIconHoverColour\');\r\n		\r\n		$html = \'\';\r\n		$html .= \'<script language=\"JavaScript\" src=\"\' . $this->getFieldTypeAttachmentURL(\'audio-player.js\'). \'\"></script>\';\r\n		$html .= \"\\n\" . \'<object type=\"application/x-shockwave-flash\" data=\"\' . $this->getFieldTypeAttachmentURL(\'player.swf\'). \'\" id=\"audioplayer\' . $id . \'\" height=\"24\" width=\"290\">\';\r\n		$html .= \"\\n\" . \'<param name=\"movie\" value=\"\' . $this->getDataAttachmentURL(). \'\">\';\r\n		$html .= \"\\n\" . \'<param name=\"FlashVars\" value=\"\';\r\n		$html .= \'playerID=\' . $id;\r\n		$html .= \'&amp;soundFile=\' . urlencode($this->getDataAttachmentURL());\r\n		foreach( $params AS $key => $value ) {\r\n			if(!empty($value)) {\r\n				$html .= \'&amp;\' . $key . \'=0x\' . $value;\r\n			}\r\n		}\r\n		$html .= \'\">\';\r\n		$html .= \"\\n\" . \'<param name=\"quality\" value=\"high\">\';\r\n		$html .= \"\\n\" . \'<param name=\"menu\" value=\"false\">\';\r\n		$html .= \"\\n\" . \'<param name=\"wmode\" value=\"transparent\">\';\r\n		$html .= \"\\n\" . \'</object>\';\r\n		if($params[\'displayfilename\']) {\r\n			$html .= \"\\n<br />\";\r\n			$html .= \"\\n\" . \'<a href=\"\' . $this->getDataAttachmentURL() . \'\" target=\"_blank\">\';\r\n			$html .= $this->getValue();\r\n			$html .= \'</a>\';\r\n		}\r\n		return $html;\r\n	}\r\n}" WHERE field_type = "audioplayer" LIMIT 1');
		$database->query();
		
		updateVersion(2,0,4);
		$this->updated = true;
		return true;
	}
}
?>
<?php
/**
 * @version		$Id: 2_0_2.php 575 2009-03-10 11:44:00Z CY $
 * @package		Mosets Tree
 * @copyright	(C) 2005-2009 Mosets Consulting. All rights reserved.
 * @license		GNU General Public License
 * @author		Lee Cher Yeong <mtree@mosets.com>
 * @url			http://www.mosets.com/tree/
 */

defined('_JEXEC') or die('Restricted access');

class mUpgrade_2_0_2 extends mUpgrade {
	function upgrade() {
		global $database;
		
		// Delete config: show_email
		$database->setQuery('DELETE FROM #__mt_config WHERE varname = "show_email" LIMIT 1');
		$database->query();
		
		// Update jQuery library to 1.1.4
		$database->setQuery('UPDATE #__mt_config SET `value` = "/components/com_mtree/js/jquery-1.1.4.pack.js", `default` = "/components/com_mtree/js/jquery-1.1.4.pack.js" WHERE varname = "relative_path_to_js_library" LIMIT 1');
		$database->query();
		
		// Add 2 new fieldtypes - coremetakey & coremetadesc
		$database->setQuery("INSERT INTO #__mt_customfields VALUES ('', 'coremetakey', 'Meta Keys', '', 0, '', '', '', '', '', 0, 23, 0, 0, 0, 0, 1, 1, 0, 0, '', '', 1)");
		$database->query();
		$database->setQuery("INSERT INTO #__mt_customfields VALUES ('', 'coremetadesc', 'Meta Description', '', 0, '', '', '', '', '', 0, 24, 0, 0, 1, 0, 0, 0, 0, 0, '', '', 1)");
		$database->query();
		$database->setQuery('INSERT INTO #__mt_fieldtypes VALUES (30, "coremetakey", "Meta Keys", "class mFieldType_coremetakey extends mFieldType {\r\n	var $name = \'metakey\';\r\n	var $numOfInputFields = 0;\r\n}", 0, 0, 0, 1)');
		$database->query();
		$database->setQuery('INSERT INTO #__mt_fieldtypes VALUES (31, "coremetadesc", "Meta Description", "class mFieldType_coremetadesc extends mFieldType {\r\n	var $name = \'metadesc\';\r\n	var $numOfInputFields = 0;\r\n}\r\n", 0, 0, 0, 1)');
		$database->query();

		// Update corefeatured field
		$database->setQuery('UPDATE #__mt_fieldtypes SET ft_class = "class mFieldType_corefeatured extends mFieldType {\r\n	var $name = \'link_featured\';\r\n	var $numOfSearchFields = 0;\r\n	var $numOfInputFields = 0;\r\n	function getOutput() {\r\n\r\n		$featured = $this->getValue();\r\n		$html = \'\';\r\n		if($featured) {\r\n			$html .= $_MT_LANG->YES;\r\n		} else {\r\n			$html .= $_MT_LANG->NO;\r\n		}\r\n		return $html;\r\n	}\r\n}" WHERE ft_id = "14" LIMIT 1');
		$database->query();

		// Update multilineTextBox field
		$database->setQuery('UPDATE #__mt_fieldtypes SET ft_class = "class mFieldType_multilineTextbox extends mFieldType {\r\n	function parseValue($value) {\r\n		$params[\'stripAllTagsBeforeSave\'] = $this->getParam(\'stripAllTagsBeforeSave\',0);\r\n		$params[\'allowedTags\'] = $this->getParam(\'allowedTags\',\'u,b,i,a,ul,li,pre,br,blockquote\');\r\n		if($params[\'stripAllTagsBeforeSave\']) {\r\n			$value = $this->stripTags($value,$params[\'allowedTags\']);\r\n		}\r\n		return $value;		\r\n	}\r\n	function getInputHTML() {\r\n		$params[\'cols\'] = $this->getParam(\'cols\',60);\r\n		$params[\'rows\'] = $this->getParam(\'rows\',6);\r\n		$params[\'style\'] = $this->getParam(\'style\',\'\');\r\n		$html = \'\';\r\n		$html .= \'<textarea name=\"\' . $this->getInputFieldName(1) . \'\" id=\"\' . $this->getInputFieldName(1) . \'\" class=\"inputbox\"\';\r\n		$html .= \' cols=\"\' . $params[\'cols\'] . \'\" rows=\"\' . $params[\'rows\'] . \'\"\';\r\n		if(!empty($params[\'style\'])) {\r\n			$html .=  \' style=\"\' . $params[\'style\'] . \'\"\';\r\n		}\r\n		$html .=  \'>\' . $this->getValue() . \'</textarea>\';\r\n		return $html;\r\n	}\r\n	function getSearchHTML() {\r\n		return \'<input class=\"inputbox\" type=\"text\" name=\"\' . $this->getName() . \'\" size=\"30\" />\';\r\n	}\r\n	function getOutput($view=1) {\r\n		$params[\'parseUrl\'] = $this->getParam(\'parseUrl\',1);\r\n		$params[\'summaryChars\'] = $this->getParam(\'summaryChars\',255);\r\n		$params[\'stripSummaryTags\'] = $this->getParam(\'stripSummaryTags\',1);\r\n		$params[\'stripDetailsTags\'] = $this->getParam(\'stripDetailsTags\',1);\r\n		$params[\'allowedTags\'] = $this->getParam(\'allowedTags\',\'u,b,i,a,ul,li,pre,br,blockquote\');\r\n	\r\n		$html = $this->getValue();\r\n	\r\n		// Details view\r\n		if($view == 1) {\r\n			if($params[\'stripDetailsTags\']) {\r\n				$html = $this->stripTags($html,$params[\'allowedTags\']);\r\n			}\r\n			if($params[\'parseUrl\'] AND $view == 0) {\r\n				$regex = \'/http:\\/\\/(.*?)(\\s|$)/i\';\r\n				$html = preg_replace_callback( $regex, array($this,\'linkcreator\'), $html );\r\n			}\r\n		// Summary view\r\n		} else {\r\n			$html = preg_replace(\'@{[\\/\\!]*?[^<>]*?}@si\', \'\', $html);\r\n			if($params[\'stripSummaryTags\']) {\r\n				$html = strip_tags( $html );\r\n			} else {\r\n			}\r\n			$trimmed_desc = $this->html_cutstr($html,$params[\'summaryChars\']);\r\n			if  ($this->strlen_utf8($html) > $params[\'summaryChars\']) {\r\n				$html = $trimmed_desc . \' <b>...</b>\';\r\n			}\r\n		}\r\n		return $html;\r\n	}\r\n}" WHERE ft_id = "26" LIMIT 1');
		$database->query();
		$database->setQuery("UPDATE #__mt_fieldtypes_att SET filedata = 0x3c6d6f73706172616d7320747970653d226d6f64756c65223e0a093c706172616d733e0a09093c706172616d206e616d653d2273756d6d61727943686172732220747970653d2274657874222064656661756c743d2232353522206c6162656c3d224e756d626572206f662053756d6d617279206368617261637465727322202f3e0a09093c706172616d206e616d653d22737472697053756d6d617279546167732220747970653d22726164696f222064656661756c743d223122206c6162656c3d22537472697020616c6c2048544d4c207461677320696e2053756d6d617279207669657722206465736372697074696f6e3d2253657474696e67207468697320746f207965732077696c6c2072656d6f766520616c6c2074616773207468617420636f756c6420706f74656e7469616c6c7920616666656374207768656e2076696577696e672061206c697374206f66206c697374696e67732e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22737472697044657461696c73546167732220747970653d22726164696f222064656661756c743d223122206c6162656c3d22537472697020616c6c2048544d4c207461677320696e2044657461696c73207669657722206465736372697074696f6e3d2253657474696e67207468697320746f207965732077696c6c2072656d6f766520616c6c2074616773206578636570742074686f73652074686174206172652073706563696669656420696e2027416c6c6f7765642074616773272e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22706172736555726c2220747970653d22726164696f222064656661756c743d223122206c6162656c3d2250617273652055524c206173206c696e6b20696e2044657461696c732076696577223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a0a09093c706172616d206e616d653d227374726970416c6c546167734265666f7265536176652220747970653d22726164696f222064656661756c743d223022206c6162656c3d22537472697020616c6c2048544d4c2074616773206265666f72652073746f72696e6720746f20646174616261736522206465736372697074696f6e3d224966205759535957494720656469746f7220697320656e61626c656420696e207468652066726f6e742d656e642c2074686973206665617475726520616c6c6f7720796f7520746f20737472697020616e7920706f74656e7469616c6c79206861726d66756c20636f6465732e20596f752063616e207374696c6c20616c6c6f7720736f6d6520746167732077697468696e206465736372697074696f6e206669656c642c2077686963682063616e206265207370656369666965642062656c6f772e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22616c6c6f776564546167732220747970653d2274657874222064656661756c743d22752c622c692c612c756c2c6c692c7072652c626c6f636b71756f746522206c6162656c3d22416c6c6f776564207461677322206465736372697074696f6e3d22456e7465722074686520746167206e616d65732073657065726174656420627920636f6d6d612e205468697320706172616d6574657220616c6c6f7720796f7520746f2061636365707420736f6d652048544d4c2074616773206576656e20696620796f75206861766520656e61626c65207374726970696e67206f6620616c6c2048544d4c20746167732061626f76652e22202f3e0a093c2f706172616d733e0a3c2f6d6f73706172616d733e, filesize = 1584 WHERE ft_id = 26 AND filename = 'params.xml' LIMIT 1");
		$database->query();

		// Update corewebsite field
		$database->setQuery('UPDATE #__mt_fieldtypes SET ft_class = "' . 'class mFieldType_corewebsite extends mFieldType_weblink {\r\n	var $name = \'website\';\r\n\r\n	function getOutput() {\r\n		$maxUrlLength = $this->getParam(\'maxUrlLength\',60);\r\n		$text = $this->getParam(\'text\',\'\');\r\n		$openNewWindow = $this->getParam(\'openNewWindow\',1);\r\n		$useMTVisitRedirect = $this->getParam(\'useMTVisitRedirect\',1);\r\n	\r\n		$html = \'\';\r\n		$html .= \'<a href=\"\';\r\n		if($useMTVisitRedirect) {\r\n			global $Itemid;\r\n			$html .= JRoute::_(\'index.php?option=com_mtree&task=visit&link_id=\' . $this->getLinkId() . \'&Itemid=\' . $Itemid);\r\n		} else {\r\n			$html .= $this->getValue();\r\n		}\r\n		$html .= \'\"\';\r\n		if( $openNewWindow == 1 ) {\r\n			$html .= \' target=\"_blank\"\';\r\n		}\r\n		$html .= \'>\';\r\n		if(!empty($text)) {\r\n			$html .= $text;\r\n		} else {\r\n			if( empty($maxUrlLength) || $maxUrlLength == 0 ) {\r\n				$html .= $this->getValue();\r\n			} else {\r\n				$html .= substr($this->getValue(),0,$maxUrlLength);\r\n				if( strlen($this->getValue()) > $maxUrlLength ) {\r\n					$html .= $this->getParam(\'clippedSymbol\');\r\n				}\r\n			}\r\n		}\r\n		$html .= \'</a>\';\r\n		return $html;\r\n	}\r\n	\r\n	function getInputHTML() {\r\n\r\n		$showGo = $this->getParam(\'showGo\',1);\r\n		$showSpider = $this->getParam(\'showSpider\',0);\r\n		$html = \'\';\r\n		$html .= \'<input class=\"text_area\" type=\"text\" name=\"\' . $this->getInputFieldName(1) . \'\" id=\"\' . $this->getInputFieldName(1) . \'\" size=\"\' . $this->getSize() . \'\" value=\"\' . htmlspecialchars($this->getValue()) . \'\" />\';\r\n		if($showGo) {\r\n			$html .= \'&nbsp;\';\r\n			$html .= \'<input type=\"button\" class=\"button\" onclick=\\\\\'\';\r\n			$html .= \'javascript:window.open(\"index3.php?option=com_mtree&task=openurl&url=\"+escape(document.getElementById(\"website\").value))\\\\\'\';\r\n			$html .= \'value=\"\' . $_MT_LANG->GO . \'\" />\';\r\n		}\r\n		if($showSpider) {\r\n			$html .= \'&nbsp;\';\r\n			$html .= \'<input type=\"button\" class=\"button\" onclick=\\\\\'\';\r\n			$html .= \'javascript: \';\r\n			$html .= \'jQuery(\"#spiderwebsite\").html(\"\' . $_MT_LANG->SPIDER_PROGRESS . \'\");\';\r\n			$html .= \'jQuery.ajax({\r\n			  type: \"POST\",\r\n			  url: mosConfig_live_site+\"/administrator/index2.php\",\r\n			  data: \"option=com_mtree&task=ajax&task2=spiderurl&url=\"+document.getElementById(\"website\").value+\"&no_html=1\",\r\n			  dataType: \"script\"\r\n			});\';\r\n			$html .= \'\\\\\'\';\r\n			$html .= \'value=\"\' . $_MT_LANG->SPIDER . \'\" />\';\r\n			$html .= \'<span id=\"spider\' . $this->getInputFieldName(1) . \'\" style=\"margin-left:5px;background-color:white\"></span>\';\r\n		}\r\n		return $html;\r\n	}\r\n	\r\n}' . '" WHERE ft_id = "11" LIMIT 1');
		$database->query();
		$database->setQuery("UPDATE #__mt_fieldtypes_att SET filedata = 0x3c6d6f73706172616d7320747970653d226d6f64756c65223e0a093c706172616d733e0a09093c706172616d206e616d653d226f70656e4e657757696e646f772220747970653d22726164696f222064656661756c743d223122206c6162656c3d224f70656e204e65772057696e646f7722206465736372697074696f6e3d224f70656e2061206e65772077696e646f77207768656e20746865206c696e6b20697320636c69636b65642e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d227573654d54566973697452656469726563742220747970653d22726164696f222064656661756c743d223122206c6162656c3d2255736520696e7465726e616c20726564697265637422206465736372697074696f6e3d225573696e6720696e7465726e65742072656469726563742077696c6c206272696e672076697369746f7273207468726f75676820616e20696e7465726e616c2055524c206265666f7265207265646972656374696e67207468656d20746f207468652061637475616c20776562736974652e205468697320616c6c6f7773204d6f73657473205472656520746f206b65657020747261636b206f6620746865206869747320616e64206869646573207468652061637475616c792055524c2066726f6d2076697369746f722e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22746578742220747970653d2274657874222064656661756c743d2222206c6162656c3d224c696e6b205465787422206465736372697074696f6e3d22557365207468697320706172616d6574657220746f207370656369667920746865206c696e6b20746578742e204966206c65667420656d7074792c207468652066756c6c2055524c2077696c6c20626520646973706c6179656420617320746865206c696e6b277320746578742e22202f3e0a09093c706172616d206e616d653d226d617855726c4c656e6774682220747970653d2274657874222064656661756c743d22363022206c6162656c3d224d61782e2055524c204c656e67746822206465736372697074696f6e3d22456e74657220746865206d6178696d756d2055524c2773206c656e677468206265666f726520697420697320636c697070656422202f3e0a09093c706172616d206e616d653d22636c697070656453796d626f6c2220747970653d2274657874222064656661756c743d222e2e2e22206c6162656c3d22436c69707065642073796d626f6c22202f3e0a0a09093c706172616d206e616d653d2273686f77476f2220747970653d22726164696f222064656661756c743d223122206c6162656c3d2253686f7720476f20627574746f6e22206465736372697074696f6e3d225468697320476f20627574746f6e2077696c6c20626520617661696c61626c6520696e20746865206261636b2d656e642045646974204c697374696e67207061676520746f20616c6c6f772061646d696e206120666173742077617920746f206f70656e20746865206c697374696e67277320776562736974652e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d2273686f775370696465722220747970653d22726164696f222064656661756c743d223022206c6162656c3d2253686f772053706964657220627574746f6e22206465736372697074696f6e3d225768656e20656e61626c65642c20612053706964657220627574746f6e2077696c6c20626520617661696c61626c65206e65787420746f20746865207765627369746520696e707574206669656c6420696e206261636b2d656e642e205768656e2074686520627574746f6e20697320636c69636b65642c2069742077696c6c20636865636b20746865207765627369746520696e20746865206261636b67726f756e20616e6420706f70756c61746520746865206c697374696e672773204d455441204b65797320616e64204d455441204465736372697074696f6e206669656c642e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a093c2f706172616d733e0a3c2f6d6f73706172616d733e, filesize = 1772 WHERE ft_id = 11 AND filename = 'params.xml' LIMIT 1");
		$database->query();
		
		// Update weblinknewwin field's params.xml
		$database->setQuery("UPDATE #__mt_fieldtypes_att SET filedata = 0x3c6d6f73706172616d7320747970653d226d6f64756c65223e0a093c706172616d733e0a09093c706172616d206e616d653d226f70656e4e657757696e646f772220747970653d22726164696f222064656661756c743d223122206c6162656c3d224f70656e204e65772057696e646f7722206465736372697074696f6e3d224f70656e2061206e65772077696e646f77207768656e20746865206c696e6b20697320636c69636b65642e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22746578742220747970653d2274657874222064656661756c743d2222206c6162656c3d224c696e6b205465787422206465736372697074696f6e3d22557365207468697320706172616d6574657220746f207370656369667920746865206c696e6b20746578742e204966206c65667420656d7074792c207468652066756c6c2055524c2077696c6c20626520646973706c6179656420617320746865206c696e6b277320746578742e22202f3e0a09093c706172616d206e616d653d226d617855726c4c656e6774682220747970653d2274657874222064656661756c743d22363022206c6162656c3d224d61782e2055524c204c656e67746822206465736372697074696f6e3d22456e74657220746865206d6178696d756d2055524c2773206c656e677468206265666f726520697420697320636c697070656422202f3e0a09093c706172616d206e616d653d22636c697070656453796d626f6c2220747970653d2274657874222064656661756c743d222e2e2e22206c6162656c3d22436c69707065642073796d626f6c22202f3e0a09093c706172616d206e616d653d2273686f77476f2220747970653d22726164696f222064656661756c743d223022206c6162656c3d2253686f7720476f20627574746f6e22206465736372697074696f6e3d225468697320476f20627574746f6e2077696c6c20626520617661696c61626c6520696e20746865206261636b2d656e642045646974204c697374696e67207061676520746f20616c6c6f772061646d696e206120666173742077617920746f206f70656e20746865206c697374696e67277320776562736974652e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a09093c2f706172616d3e0a093c2f706172616d733e0a3c2f6d6f73706172616d733e, filesize = 982 WHERE ft_id = 23 AND filename = 'params.xml' LIMIT 1");
		$database->query();

		updateVersion(2,0,2);
		$this->updated = true;
		return true;
	}
}
?>